<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power-Up System Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }

        .test-pass {
            background-color: #2d5a2d;
            border: 1px solid #4a8a4a;
        }

        .test-fail {
            background-color: #5a2d2d;
            border: 1px solid #8a4a4a;
        }

        .test-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 5px;
        }

        h1 {
            color: #00ffff;
        }

        h2 {
            color: #ffff00;
        }
    </style>
</head>

<body>
    <h1>Power-Up System Unit Tests</h1>
    <div id="test-results"></div>
    <div id="test-summary" class="test-summary"></div>

    <script>
        // Simple test framework
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = [];
            }

            test(name, testFunction) {
                this.tests.push({ name, testFunction });
            }

            run() {
                this.results = [];
                const resultsDiv = document.getElementById('test-results');
                resultsDiv.innerHTML = '';

                this.tests.forEach(({ name, testFunction }) => {
                    try {
                        testFunction();
                        this.results.push({ name, passed: true, error: null });
                        this.displayResult(name, true, null);
                    } catch (error) {
                        this.results.push({ name, passed: false, error: error.message });
                        this.displayResult(name, false, error.message);
                    }
                });

                this.displaySummary();
            }

            displayResult(name, passed, error) {
                const resultsDiv = document.getElementById('test-results');
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                resultDiv.innerHTML = `
                    <strong>${passed ? '✓' : '✗'} ${name}</strong>
                    ${error ? `<br><small>Error: ${error}</small>` : ''}
                `;
                resultsDiv.appendChild(resultDiv);
            }

            displaySummary() {
                const summaryDiv = document.getElementById('test-summary');
                const passed = this.results.filter(r => r.passed).length;
                const total = this.results.length;
                const failed = total - passed;

                summaryDiv.innerHTML = `
                    <h2>Test Summary</h2>
                    <p><strong>Total Tests:</strong> ${total}</p>
                    <p><strong>Passed:</strong> ${passed}</p>
                    <p><strong>Failed:</strong> ${failed}</p>
                    <p><strong>Success Rate:</strong> ${((passed / total) * 100).toFixed(1)}%</p>
                `;
            }

            assert(condition, message) {
                if (!condition) {
                    throw new Error(message || 'Assertion failed');
                }
            }

            assertEqual(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `Expected ${expected}, but got ${actual}`);
                }
            }

            assertTrue(condition, message) {
                if (!condition) {
                    throw new Error(message || 'Expected true, but got false');
                }
            }

            assertFalse(condition, message) {
                if (condition) {
                    throw new Error(message || 'Expected false, but got true');
                }
            }

            assertGreaterThan(actual, expected, message) {
                if (actual <= expected) {
                    throw new Error(message || `Expected ${actual} to be greater than ${expected}`);
                }
            }

            assertLessThan(actual, expected, message) {
                if (actual >= expected) {
                    throw new Error(message || `Expected ${actual} to be less than ${expected}`);
                }
            }
        }

        // Mock canvas context for testing
        const mockCtx = {
            fillStyle: '',
            strokeStyle: '',
            lineWidth: 0,
            globalAlpha: 1,
            shadowColor: '',
            shadowBlur: 0,
            font: '',
            textAlign: '',
            textBaseline: '',
            fillRect: function () { },
            strokeRect: function () { },
            fillText: function () { },
            save: function () { },
            restore: function () { },
            translate: function () { },
            rotate: function () { }
        };

        // Power-up type definitions (copied from game.js)
        const POWER_UP_TYPES = {
            RAPID_FIRE: {
                name: "Rapid Fire",
                description: "Increases shooting frequency by 300% for 8 seconds",
                duration: 8000,
                color: "#ff4444",
                glowColor: "#ff8888",
                symbol: "R",
                effect: (player) => {
                    player.originalShootCooldown = player.shootCooldown;
                    player.shootCooldown = Math.floor(player.shootCooldown * 0.25);
                },
                removeEffect: (player) => {
                    if (player.originalShootCooldown) {
                        player.shootCooldown = player.originalShootCooldown;
                        delete player.originalShootCooldown;
                    }
                }
            },
            WIDE_SHOT: {
                name: "Wide Shot",
                description: "Fires 5 bullets in a spread pattern for 10 seconds",
                duration: 10000,
                color: "#44ff44",
                glowColor: "#88ff88",
                symbol: "W",
                effect: (player) => {
                    player.bulletSpread = 5;
                    player.spreadAngle = 0.3;
                },
                removeEffect: (player) => {
                    player.bulletSpread = 1;
                    delete player.spreadAngle;
                }
            },
            SHIELD_GENERATOR: {
                name: "Shield Generator",
                description: "Provides complete invincibility for 5 seconds",
                duration: 5000,
                color: "#4444ff",
                glowColor: "#8888ff",
                symbol: "S",
                effect: (player) => {
                    player.invincible = true;
                    player.shieldAlpha = 0;
                },
                removeEffect: (player) => {
                    player.invincible = false;
                    delete player.shieldAlpha;
                }
            },
            TIME_SLOW: {
                name: "Time Slow",
                description: "Reduces all enemy movement by 70% for 12 seconds",
                duration: 12000,
                color: "#ff44ff",
                glowColor: "#ff88ff",
                symbol: "T",
                effect: (game) => {
                    game.timeScale = 0.3;
                },
                removeEffect: (game) => {
                    game.timeScale = 1.0;
                }
            },
            MEGA_BLAST: {
                name: "Mega Blast",
                description: "Fires penetrating bullets that destroy multiple enemies for 6 seconds",
                duration: 6000,
                color: "#ffff44",
                glowColor: "#ffff88",
                symbol: "M",
                effect: (player) => {
                    player.bulletPenetration = true;
                    player.bulletDamage = 2;
                },
                removeEffect: (player) => {
                    player.bulletPenetration = false;
                    player.bulletDamage = 1;
                }
            },
            AUTO_AIM: {
                name: "Auto-Aim",
                description: "Bullets automatically track the nearest enemy for 15 seconds",
                duration: 15000,
                color: "#44ffff",
                glowColor: "#88ffff",
                symbol: "A",
                effect: (player) => {
                    player.autoAim = true;
                },
                removeEffect: (player) => {
                    player.autoAim = false;
                }
            }
        };

        // Mock classes for testing
        class PowerUp {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.width = 24;
                this.height = 24;
                this.speed = 1 + Math.random() * 0.5;
                this.type = type;
                this.config = POWER_UP_TYPES[type];
                this.rotation = 0;
                this.pulsePhase = Math.random() * Math.PI * 2;
                this.lifetime = 10000;
                this.age = 0;
            }

            update() {
                this.y += this.speed;
                this.rotation += 0.05;
                this.pulsePhase += 0.1;
                this.age += 16;
            }

            isExpired() {
                return this.age >= this.lifetime;
            }

            collidesWith(other) {
                return this.x < other.x + other.width &&
                    this.x + this.width > other.x &&
                    this.y < other.y + other.height &&
                    this.y + this.height > other.y;
            }
        }

        class PowerUpSystem {
            constructor() {
                this.powerUps = [];
                this.activePowerUps = [];
                this.lastSpawn = 0;
                this.spawnRate = 15000 + Math.random() * 10000;
            }

            spawnPowerUp(canvasWidth) {
                const powerUpTypes = Object.keys(POWER_UP_TYPES);
                const randomType = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
                const x = Math.random() * (canvasWidth - 24);

                this.powerUps.push(new PowerUp(x, -30, randomType));
            }

            collectPowerUp(powerUp, game) {
                const index = this.powerUps.indexOf(powerUp);
                if (index > -1) {
                    this.powerUps.splice(index, 1);
                }

                this.applyPowerUpEffect(powerUp, game);

                this.activePowerUps.push({
                    type: powerUp.type,
                    config: powerUp.config,
                    timeRemaining: powerUp.config.duration,
                    startTime: Date.now()
                });
            }

            applyPowerUpEffect(powerUp, game) {
                const config = powerUp.config;

                if (config.effect) {
                    if (powerUp.type === 'TIME_SLOW') {
                        config.effect(game);
                    } else {
                        config.effect(game.player);
                    }
                }
            }

            removePowerUpEffect(activePowerUp, game) {
                const config = activePowerUp.config;

                if (config.removeEffect) {
                    if (activePowerUp.type === 'TIME_SLOW') {
                        config.removeEffect(game);
                    } else {
                        config.removeEffect(game.player);
                    }
                }
            }

            getActivePowerUps() {
                return this.activePowerUps;
            }
        }

        // Mock Player class
        class MockPlayer {
            constructor() {
                this.x = 100;
                this.y = 100;
                this.width = 40;
                this.height = 30;
                this.shootCooldown = 150;
                this.bulletSpread = 1;
                this.bulletDamage = 1;
                this.invincible = false;
                this.bulletPenetration = false;
                this.autoAim = false;
            }
        }

        // Mock Game class
        class MockGame {
            constructor() {
                this.player = new MockPlayer();
                this.timeScale = 1.0;
                this.canvas = { width: 800 };
            }
        }

        // Initialize test runner
        const testRunner = new TestRunner();

        // Power-Up Creation Tests
        testRunner.test('PowerUp creates with correct properties', () => {
            const powerUp = new PowerUp(100, 200, 'RAPID_FIRE');

            testRunner.assertEqual(powerUp.x, 100, 'PowerUp should have correct x position');
            testRunner.assertEqual(powerUp.y, 200, 'PowerUp should have correct y position');
            testRunner.assertEqual(powerUp.type, 'RAPID_FIRE', 'PowerUp should have correct type');
            testRunner.assertEqual(powerUp.config.name, 'Rapid Fire', 'PowerUp should have correct config');
            testRunner.assertEqual(powerUp.width, 24, 'PowerUp should have correct width');
            testRunner.assertEqual(powerUp.height, 24, 'PowerUp should have correct height');
        });

        testRunner.test('PowerUp updates position and age', () => {
            const powerUp = new PowerUp(100, 200, 'RAPID_FIRE');
            const initialY = powerUp.y;
            const initialAge = powerUp.age;

            powerUp.update();

            testRunner.assertGreaterThan(powerUp.y, initialY, 'PowerUp should move down');
            testRunner.assertGreaterThan(powerUp.age, initialAge, 'PowerUp age should increase');
        });

        testRunner.test('PowerUp expires after lifetime', () => {
            const powerUp = new PowerUp(100, 200, 'RAPID_FIRE');

            testRunner.assertFalse(powerUp.isExpired(), 'New PowerUp should not be expired');

            powerUp.age = powerUp.lifetime + 1;
            testRunner.assertTrue(powerUp.isExpired(), 'PowerUp should be expired after lifetime');
        });

        testRunner.test('PowerUp collision detection works', () => {
            const powerUp = new PowerUp(100, 100, 'RAPID_FIRE');
            const player = { x: 90, y: 90, width: 40, height: 30 };
            const farPlayer = { x: 200, y: 200, width: 40, height: 30 };

            testRunner.assertTrue(powerUp.collidesWith(player), 'PowerUp should collide with overlapping player');
            testRunner.assertFalse(powerUp.collidesWith(farPlayer), 'PowerUp should not collide with distant player');
        });

        // Power-Up System Tests
        testRunner.test('PowerUpSystem initializes correctly', () => {
            const system = new PowerUpSystem();

            testRunner.assertEqual(system.powerUps.length, 0, 'System should start with no power-ups');
            testRunner.assertEqual(system.activePowerUps.length, 0, 'System should start with no active power-ups');
        });

        testRunner.test('PowerUpSystem spawns power-ups', () => {
            const system = new PowerUpSystem();

            system.spawnPowerUp(800);

            testRunner.assertEqual(system.powerUps.length, 1, 'System should have one power-up after spawning');
            testRunner.assertTrue(system.powerUps[0] instanceof PowerUp, 'Spawned item should be a PowerUp');
        });

        testRunner.test('PowerUpSystem spawns random power-up types', () => {
            const system = new PowerUpSystem();
            const spawnedTypes = new Set();

            // Spawn multiple power-ups to test randomness
            for (let i = 0; i < 20; i++) {
                system.spawnPowerUp(800);
                spawnedTypes.add(system.powerUps[i].type);
            }

            testRunner.assertGreaterThan(spawnedTypes.size, 1, 'Should spawn different power-up types');
        });

        // Power-Up Effect Tests
        testRunner.test('Rapid Fire power-up reduces shoot cooldown', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'RAPID_FIRE');
            const system = new PowerUpSystem();
            const originalCooldown = game.player.shootCooldown;

            system.collectPowerUp(powerUp, game);

            testRunner.assertLessThan(game.player.shootCooldown, originalCooldown, 'Shoot cooldown should be reduced');
            testRunner.assertEqual(game.player.originalShootCooldown, originalCooldown, 'Original cooldown should be stored');
        });

        testRunner.test('Wide Shot power-up enables bullet spread', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'WIDE_SHOT');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);

            testRunner.assertEqual(game.player.bulletSpread, 5, 'Bullet spread should be set to 5');
            testRunner.assertEqual(game.player.spreadAngle, 0.3, 'Spread angle should be set');
        });

        testRunner.test('Shield Generator power-up enables invincibility', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'SHIELD_GENERATOR');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);

            testRunner.assertTrue(game.player.invincible, 'Player should be invincible');
            testRunner.assertEqual(game.player.shieldAlpha, 0, 'Shield alpha should be initialized');
        });

        testRunner.test('Time Slow power-up reduces game time scale', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'TIME_SLOW');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);

            testRunner.assertEqual(game.timeScale, 0.3, 'Time scale should be reduced to 0.3');
        });

        testRunner.test('Mega Blast power-up enables penetration and increases damage', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'MEGA_BLAST');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);

            testRunner.assertTrue(game.player.bulletPenetration, 'Bullet penetration should be enabled');
            testRunner.assertEqual(game.player.bulletDamage, 2, 'Bullet damage should be increased to 2');
        });

        testRunner.test('Auto-Aim power-up enables auto-aim', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'AUTO_AIM');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);

            testRunner.assertTrue(game.player.autoAim, 'Auto-aim should be enabled');
        });

        // Power-Up Removal Tests
        testRunner.test('Rapid Fire effect is properly removed', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'RAPID_FIRE');
            const system = new PowerUpSystem();
            const originalCooldown = game.player.shootCooldown;

            system.collectPowerUp(powerUp, game);
            const activePowerUp = system.activePowerUps[0];
            system.removePowerUpEffect(activePowerUp, game);

            testRunner.assertEqual(game.player.shootCooldown, originalCooldown, 'Shoot cooldown should be restored');
            testRunner.assertTrue(game.player.originalShootCooldown === undefined, 'Original cooldown should be cleaned up');
        });

        testRunner.test('Wide Shot effect is properly removed', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'WIDE_SHOT');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);
            const activePowerUp = system.activePowerUps[0];
            system.removePowerUpEffect(activePowerUp, game);

            testRunner.assertEqual(game.player.bulletSpread, 1, 'Bullet spread should be reset to 1');
            testRunner.assertTrue(game.player.spreadAngle === undefined, 'Spread angle should be cleaned up');
        });

        testRunner.test('Shield Generator effect is properly removed', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'SHIELD_GENERATOR');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);
            const activePowerUp = system.activePowerUps[0];
            system.removePowerUpEffect(activePowerUp, game);

            testRunner.assertFalse(game.player.invincible, 'Player should no longer be invincible');
            testRunner.assertTrue(game.player.shieldAlpha === undefined, 'Shield alpha should be cleaned up');
        });

        testRunner.test('Time Slow effect is properly removed', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'TIME_SLOW');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);
            const activePowerUp = system.activePowerUps[0];
            system.removePowerUpEffect(activePowerUp, game);

            testRunner.assertEqual(game.timeScale, 1.0, 'Time scale should be restored to 1.0');
        });

        testRunner.test('Mega Blast effect is properly removed', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'MEGA_BLAST');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);
            const activePowerUp = system.activePowerUps[0];
            system.removePowerUpEffect(activePowerUp, game);

            testRunner.assertFalse(game.player.bulletPenetration, 'Bullet penetration should be disabled');
            testRunner.assertEqual(game.player.bulletDamage, 1, 'Bullet damage should be reset to 1');
        });

        testRunner.test('Auto-Aim effect is properly removed', () => {
            const game = new MockGame();
            const powerUp = new PowerUp(100, 100, 'AUTO_AIM');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp, game);
            const activePowerUp = system.activePowerUps[0];
            system.removePowerUpEffect(activePowerUp, game);

            testRunner.assertFalse(game.player.autoAim, 'Auto-aim should be disabled');
        });

        // Active Power-Up Management Tests
        testRunner.test('Active power-ups are tracked correctly', () => {
            const game = new MockGame();
            const powerUp1 = new PowerUp(100, 100, 'RAPID_FIRE');
            const powerUp2 = new PowerUp(200, 200, 'SHIELD_GENERATOR');
            const system = new PowerUpSystem();

            system.collectPowerUp(powerUp1, game);
            system.collectPowerUp(powerUp2, game);

            testRunner.assertEqual(system.activePowerUps.length, 2, 'Should have 2 active power-ups');
            testRunner.assertEqual(system.activePowerUps[0].type, 'RAPID_FIRE', 'First power-up should be Rapid Fire');
            testRunner.assertEqual(system.activePowerUps[1].type, 'SHIELD_GENERATOR', 'Second power-up should be Shield Generator');
        });

        testRunner.test('Power-up collection removes from spawn list', () => {
            const game = new MockGame();
            const system = new PowerUpSystem();

            system.spawnPowerUp(800);
            const powerUp = system.powerUps[0];

            testRunner.assertEqual(system.powerUps.length, 1, 'Should have 1 spawned power-up');

            system.collectPowerUp(powerUp, game);

            testRunner.assertEqual(system.powerUps.length, 0, 'Should have 0 spawned power-ups after collection');
        });

        testRunner.test('All power-up types have required properties', () => {
            Object.keys(POWER_UP_TYPES).forEach(type => {
                const config = POWER_UP_TYPES[type];

                testRunner.assertTrue(typeof config.name === 'string', `${type} should have a name`);
                testRunner.assertTrue(typeof config.description === 'string', `${type} should have a description`);
                testRunner.assertTrue(typeof config.duration === 'number', `${type} should have a duration`);
                testRunner.assertTrue(typeof config.color === 'string', `${type} should have a color`);
                testRunner.assertTrue(typeof config.symbol === 'string', `${type} should have a symbol`);
                testRunner.assertTrue(typeof config.effect === 'function', `${type} should have an effect function`);
                testRunner.assertTrue(typeof config.removeEffect === 'function', `${type} should have a removeEffect function`);
            });
        });

        // Run all tests when page loads
        window.addEventListener('load', () => {
            testRunner.run();
        });
    </script>
</body>

</html>